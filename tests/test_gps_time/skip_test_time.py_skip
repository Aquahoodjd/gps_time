import pytest
# import agsim.utilities.time as time
import datetime
import numpy as np
from typing import Tuple
import re








def test_datetime_to_iso():
    dt = datetime.datetime(1995, 2, 22)
    iso_str = time.datetime_to_iso(dt)
    m = re.match(time.ISO_FMT, iso_str)
    assert m is not None


@pytest.mark.parametrize("iso_str", [
    "1995-02-22T04:02:03.123456",
    "1995-02-22T04:02:03.123456",
    "199502-22T04:02:03.123456",
    "1995022204:02:03.123456",
    "19950222T0402:03.123456",
    "19950222040203.123456",
    "19950222040203123456",
    "19950222 0402:03.123456",
    "1995-02-22T04:02:03",
])
def test_cast_to_datetime(iso_str):
    time.cast_to_datetime(iso_str) == datetime.datetime(1995, 2, 22, 4, 
                                                        2, 3, 123456)


def test_cast_to_datetime_invalid():
    with pytest.raises(IOError):
        time.cast_to_datetime("not iso")











def test_array_time_difference():
    arr1 = np.array([datetime.datetime(2019, 1, 1, 0, 0, 0)])
    arr2 = np.array([datetime.datetime(2019, 1, 1, 0, 0, 0)])
    diff1 = time.array_time_difference(arr1, arr2)
    arr3 = np.array([datetime.datetime(2019, 1, 1, 0, 0, 1)])
    diff2 = time.array_time_difference(arr1, arr3)
    diff3 = time.array_time_difference(arr1, datetime.datetime(2019, 1, 1, 0, 0, 0))
    diff4 = diff3 = time.array_time_difference(datetime.datetime(2019, 1, 1, 0, 0, 0), arr1)
    assert diff1[0] == 0
    assert diff2[0] == -1
    assert diff3[0] == 0
    assert diff4[0] == 0


def test_array_time_difference_TypeError_datetime_array():
    date = datetime.datetime(2019, 1, 1)
    with pytest.raises(TypeError):
        time.array_time_difference(1, date)
    with pytest.raises(TypeError):
        time.array_time_difference(date, 1)
    with pytest.raises(TypeError):
        time.array_time_difference(np.array([1, date]), date)
    with pytest.raises(TypeError):
        time.array_time_difference(date, np.array([1, date]))
    

def test_diff_seconds():
    date1 = datetime.datetime(2019, 1, 1, 0, 0, 0)
    date2 = datetime.datetime(2019, 1, 1, 0, 0, 1)
    arr1 = np.array([date1])
    arr2 = np.array([date2])
    diff1 = time.diff_seconds(date1, arr1)
    diff2 = time.diff_seconds(date1, arr2)
    assert diff1[0] == 0
    assert diff2[0] == -1


def test_subtract_time_delta():
    date = datetime.datetime(2019, 1, 1, 0, 0, 1)
    date_out = datetime.datetime(2019, 1, 1, 0, 0, 0)
    arr = np.array([date])
    diff = time.subtract_timedelta(arr, [1])
    assert diff[0] == date_out


def test_subtract_timedelta_as_tow():
    date = datetime.datetime(1980, 1, 6, 0, 0, 1)
    tow_out = (0, 0)
    arr = np.array([date])
    diff = time.subtract_timedelta_as_tow(arr, [1])
    assert all(diff[0] == tow_out)






